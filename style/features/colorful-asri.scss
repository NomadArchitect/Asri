@use '../base' as *;

// --asri-sys-accent、 --asri-sys-accent-accessible是用 JavaScript 获取的基础颜色
// accent-accessible 跟 accent 相同，但仅当系统强调色（在 HSL 色彩空间中）的饱和度大于 0.3 时可用，否则使用备选颜色；
// --b3-theme-accent 是一个新的 UI 色，用于突出和区分元素（如激活状态的图标）；

// --asri-c-factor: [0, 5], 面板色色度系数，默认为 1；
// --asri-c-0: 色度为 0 时为 0，否则不可用；
// --asri-h-shift: [0, 360], 主题色色相偏移，默认为 0；


@supports (color: oklch(from red clamp(0, (l * 0.5), 0.3) 0 h)) {
    :root[data-theme-mode='light'] {
        --asri-base-color: var(--asri-user-custom-accent, var(--asri-sys-accent));
        --asri-theme-accent-customized: oklch(from var(--asri-user-custom-accent) .67 .18 calc(h + var(--asri-h-shift, 0)));

        --asri-fallback-accent: #3478f6; //oklch(0.6 0.2 261.37)
        --asri-fallback-background: #fff;
        --asri-fallback-surface: #f0f0f0;
        --asri-fallback-on-background: #454545;
        --asri-composite-background: oklch(from var(--asri-base-color) calc(1 - var(--asri-c-0, .015)) calc(.005 * var(--asri-c-factor, 1) * var(--asri-c-0, 1)) h);
        --asri-composite-surface: oklch(from var(--asri-base-color) calc(.96 - var(--asri-c-0, .02)) calc(.01 * var(--asri-c-factor, 1) * var(--asri-c-0, 1)) h);
        --asri-composite-on-background: oklch(from var(--asri-base-color) .39 clamp(0, .03 * var(--asri-c-factor, 1) * var(--asri-c-0, 1), .06) calc(h + var(--asri-h-shift, 0)));

        // UI colors
        // --b3-theme-primary: oklch(from var(--asri-sys-accent, var(--asri-accent-fallback)) clamp(0.5,l,0.8) c h); // complex calculation not supported yet
        --b3-theme-primary: oklch(from var(--asri-base-color, var(--asri-fallback-accent)) .67 c calc(h + var(--asri-h-shift, 0)));
        --b3-theme-primary-light: oklch(from var(--b3-theme-primary) l c h / .56);
        --b3-theme-primary-lighter: oklch(from var(--b3-theme-primary) l c h / .38);
        --b3-theme-primary-lightest: oklch(from var(--b3-theme-primary) l c h / .2);
        --b3-theme-accent: var(--asri-theme-accent-customized, oklch(from var(--asri-sys-accent-accessible, oklch(from var(--b3-theme-primary) l 0.2 h)) .67 c calc(h + var(--asri-h-shift, 0))));
        --b3-menu-item-background-hover: oklch(from var(--asri-base-color, var(--asri-fallback-accent)) .62 c calc(h + var(--asri-h-shift, 0)) / .8);

        --b3-theme-background: var(--asri-composite-background, var(--asri-fallback-background));
        --b3-theme-surface: var(--asri-composite-surface, var(--asri-fallback-surface));
        --b3-theme-on-background: var(--asri-composite-on-background, var(--asri-fallback-on-background));
        --b3-theme-on-surface: oklch(from var(--b3-theme-on-background) l c h / .65);

        --b3-theme-background-light: oklch(from var(--b3-theme-background) l c h / .1);
        --b3-theme-surface-light: oklch(from var(--b3-theme-surface) l c h / .5);
        --b3-theme-surface-lighter: oklch(from var(--b3-theme-surface) .9 c h);
        --b3-theme-on-surface-light: oklch(from var(--b3-theme-on-surface) .65 c h / .68);

        --b3-theme-on-primary: oklch(from var(--b3-theme-primary) .99 .01 h);

        --b3-border-color: oklch(from var(--b3-theme-on-background) .92 clamp(0, .01 * var(--asri-c-factor, 1), .04) h);
        --b3-border-color-trans: oklch(from var(--b3-theme-on-background) l c h / .15);

        --b3-menu-background: oklch(from var(--b3-theme-background) .95 c h);

        --b3-list-hover: oklch(from var(--b3-theme-on-background) l c h / .08);

        --b3-av-background-hl: oklch(from var(--b3-theme-primary) .95 .02 h);
        --b3-av-hover: oklch(from var(--b3-theme-on-background) .93 .02 h);

        --b3-scroll-color: oklch(from var(--b3-theme-on-background) l c h / .09);
        --b3-scroll-color-hover: oklch(from var(--b3-theme-on-background) l c h / .18);

        --b3-protyle-code-background: oklch(from var(--b3-theme-surface) .9 c h / .5);

        @for $i from 1 through 10 {
            --b3-font-color#{$i + 3}: oklch(0.6 0.23 calc(360 / 10 * #{ $i } + 30));
            --b3-font-background#{$i + 3}: oklch(0.97 0.05 calc(360 / 10 * #{ $i } + 30));
        }
    }

    :root[data-theme-mode='dark'] {
        --asri-base-color: var(--asri-user-custom-accent, var(--asri-sys-accent));
        --asri-theme-accent-customized: oklch(from var(--asri-user-custom-accent) .7 .17 calc(h + var(--asri-h-shift, 0)));

        --asri-fallback-accent: #118bff; // oklch(0.64 0.2 253.9)
        --asri-fallback-background: #1e1e1e;
        --asri-fallback-surface: #383838;
        --asri-fallback-on-background: #dcdcdc;
        --asri-composite-background: oklch(from var(--asri-base-color) .25 calc(.01 * var(--asri-c-factor, 1) * var(--asri-c-0, 1)) h);
        --asri-composite-surface: oklch(from var(--asri-base-color) .34 calc(.012 * var(--asri-c-factor, 1) * var(--asri-c-0, 1)) h);
        --asri-composite-on-background: oklch(from var(--asri-base-color) .89 clamp(0, .01 * var(--asri-c-factor, 1) * var(--asri-c-0, 1), .04) calc(h + var(--asri-h-shift, 0)));

        --b3-theme-primary: oklch(from var(--asri-base-color, var(--asri-fallback-accent)) .65 c calc(h + var(--asri-h-shift, 0)));
        --b3-theme-primary-light: oklch(from var(--b3-theme-primary) l c h / .56);
        --b3-theme-primary-lighter: oklch(from var(--b3-theme-primary) l c h / .38);
        --b3-theme-primary-lightest: oklch(from var(--b3-theme-primary) l c h / .2);
        --b3-theme-accent: var(--asri-theme-accent-customized, oklch(from var(--asri-sys-accent-accessible, oklch(from var(--b3-theme-primary) l 0.2 h)) .65 c calc(h + var(--asri-h-shift, 0))));
        --b3-menu-item-background-hover: oklch(from var(--asri-base-color, var(--asri-fallback-accent)) .6 c calc(h + var(--asri-h-shift, 0)) / .7);

        --b3-theme-background: var(--asri-composite-background, var(--asri-fallback-background));
        --b3-theme-surface: var(--asri-composite-surface, var(--asri-fallback-surface));

        --b3-theme-on-background: var(--asri-composite-on-background, var(--asri-fallback-on-background));
        --b3-theme-on-surface: oklch(from var(--b3-theme-on-background) l c h / .65);

        --b3-theme-background-light: oklch(from var(--b3-theme-background) l c h / .1);
        --b3-theme-surface-light: oklch(from var(--b3-theme-surface) l c h / .5);
        --b3-theme-on-surface-light: oklch(from var(--b3-theme-on-surface) .6 c h / .68);

        --b3-theme-on-primary: oklch(from var(--b3-theme-primary) .99 .01 h);

        --b3-border-color: oklch(from var(--b3-theme-on-background) .38 clamp(0, .01 * var(--asri-c-factor, 1), .04) h);
        --b3-border-color-trans: oklch(from var(--b3-theme-on-background) l c h / .15);

        --b3-menu-background: oklch(from var(--b3-theme-background) .3 c h);

        --b3-list-hover: oklch(from var(--b3-theme-on-background) l c h / .08);

        --b3-av-background-hl: oklch(from var(--b3-theme-primary) .32 .03 h);
        --b3-av-hover: oklch(from var(--b3-theme-on-background) .35 .02 h); // database header hover

        --b3-scroll-color: oklch(from var(--b3-theme-on-background) l c h / .09);
        --b3-scroll-color-hover: oklch(from var(--b3-theme-on-background) l c h / .18);

        --b3-protyle-code-background: oklch(from var(--b3-theme-surface) .4 c h / .6);

        @for $i from 1 through 10 {
            --b3-font-color#{$i + 3}: oklch(0.83 0.17 calc(360 / 10 * #{ $i } + 30));
            --b3-font-background#{$i + 3}: oklch(0.35 0.05 calc(360 / 10 * #{ $i } + 30));
        }
    }

    // asri config menu
    #commonMenu[data-name="barmode"] {
        right: 40px;
        left: unset !important;

        .body--mac &,
        .body--browser & {
            right: 8px;
        }

        .b3-menu__separator {
            cursor: default;
        }

        #followSysAccent {
            &.b3-menu__item--selected {
                svg {
                    background-color: var(--asri-sys-accent);
                    border-radius: 15px;
                }

                &.b3-menu__item--current svg {
                    outline: 1px solid #fffa;
                }
            }
        }

        #pickColor {
            &.b3-menu__item--selected {
                svg {
                    background-color: var(--asri-user-custom-accent, var(--b3-theme-primary));
                    border-radius: 15px;
                }

                &.b3-menu__item--current svg {
                    outline: 1px solid #fffa;
                }
            }

            input {
                visibility: hidden;
                width: 0;
                height: 0;
                padding: 0;
            }
        }

        #followSysAccent,
        #pickColor {
            label {
                cursor: pointer;
            }
        }

        #asriChroma,
        #asriHueShift {
            cursor: default;

            .b3-tooltips {
                flex-grow: 1;
            }

            svg {
                margin-right: 4px;
                transform: scale(1.1);
            }
        }

        #asriChromaSlider,
        #asriHueShiftSlider {
            cursor: pointer;
        }

        #asriHueShift {
            > svg {
                transform: scale(1.1) rotate(calc(var(--asri-h-shift, 0) * 1deg));
            }
        }

        .asri-config {
            &[disabled] {
                opacity: 0.5;
                pointer-events: none;
                cursor: not-allowed;
            }
        }
    }

    // adapt elements that need to be accented
    #toolbar .toolbar__item--active,
    .block__icon--active,
    .b3-menu__item--selected,
    .protyle-toolbar__item--current,
    .protyle-attr--refcount:hover,
    .protyle-attr--av:hover>:is(svg, span),
    .custom-attr .block__logo.custom-attr__avheader {
        color: var(--b3-theme-accent);
    }

    .b3-menu__icon[style="color:var(--b3-theme-primary)"],
    .dock .dock__item--activefocus,
    .dock .dock__item--active,
    .b3-list-item__text mark {
        color: var(--b3-theme-accent) !important;
    }

    .av__drag-fill {
        border-color: rgb(from var(--b3-theme-accent) r g b / 0.5);
    }

    .config-account__cover[style="background-image: url()"] {
        background-color: oklch(from var(--b3-theme-accent) l c h / 0.3) !important;
    }

    .protyle-wysiwyg [data-node-id] span[data-type~=search-mark].search-mark--hl {
        background-color: oklch(from var(--b3-theme-accent) l c h / .38) !important;

        @include menu-shadow(var(--b3-theme-accent), $opacity-light: 0.15, $opacity-dark: 0.4);
    }

    // other 
    .b3-list-item--focus {
        // background-color: oklch(from var(--b3-theme-primary) l c h / .2);
        background-color: oklch(from var(--b3-theme-primary) .5 calc(c * .9 * var(--asri-c-0, 1)) h / .1) !important;

        @include darkmode-counterpart {
            background-color: oklch(from var(--b3-theme-primary) .9 calc(c * .9 * var(--asri-c-0, 1)) h / .13) !important;
        }
    }

    .layout-tab-bar .item:not(.item--readonly, .item--full.item--focus):hover,
    .layout-tab-bar .item--focus {
        background-color: oklch(from var(--b3-theme-primary) .43 calc(c * .9 * var(--asri-c-0, 1)) h / .2);

        @include darkmode-counterpart {
            background-color: oklch(from var(--b3-theme-primary) .99 calc(c * .9 * var(--asri-c-0, 1)) h / .21);
        }
    }

    .b3-dialog__scrim {
        background-color: oklch(from var(--b3-theme-background) .6 c h / .5);

        @include darkmode-counterpart {
            background-color: oklch(from var(--b3-theme-background) .1 c h / .65);
        }
    }

    .toolbarButton.toggled,
    .secondaryToolbarButton.toggled {
        color: var(--b3-theme-accent);
    }
    
    // database chips
    @for $i from 1 through 10 {
        .b3-chip[style*="background-color:var(--b3-font-background#{$i + 3});color:var(--b3-font-color#{$i + 3})"] {
            color: oklch(0.4 0.1 calc(360 / 10 * #{ $i } + 30)) !important;
            background-color: oklch(from var(--b3-font-background#{$i + 3}) 0.95 c h) !important;

            @include darkmode-counterpart {
                color: oklch(0.89 0.05 calc(360 / 10 * #{ $i } + 30)) !important;
                background-color: oklch(from var(--b3-font-background#{$i + 3}) 0.35 c h) !important;
            }
        }        
    }

    @for $i from 1 through 3 {
        .b3-chip[style="background-color:var(--b3-font-background#{$i});color:var(--b3-font-color#{$i})"] {
            color: oklch(from var(--b3-font-color#{$i}) 0.4 c h) !important;

            @include darkmode-counterpart {
                color: oklch(from var(--b3-font-color#{$i}) 0.89 c h) !important;
            }
        }
    }

    .b3-chip[style*="background-color:var(--b3-font-background1);color:var(--b3-font-color1)"] {
        outline: 1px solid var(--b3-border-color-trans);
        outline-offset: -1px;
    }

    .b3-switch {
        background-color: oklch(from var(--b3-theme-on-background) .6 clamp(0, .01 * var(--asri-c-factor, 1), .03) h / .4);
    }
}